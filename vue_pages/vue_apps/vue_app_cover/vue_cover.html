<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>coverage portal demo</title>
    <style>
      .el-table .tb-header {
        color: #534d4d;
        background: #f2f3f1;
      }
    </style>
    <link rel="stylesheet" href="../../css/element.css" />
  </head>
  <body>
    <div id="app">
      <h3 style="text-align: center">Code Coverage Portal Demo</h3>
      <!-- coverage table -->
      <div style="margin-top: 30px">
        <el-table
          border
          :header-cell-class-name="getHeaderCellClassName"
          :data="tableData"
          style="width: 85%; margin: auto"
        >
          <el-table-column
            prop="index"
            label="Index"
            width="60"
            align="center"
          ></el-table-column>

          <el-table-column
            prop="srv_name"
            label="Service Name"
            width="400"
            align="center"
          >
            <template slot-scope="scope">
              <el-tag>{{scope.row.srv_name}}</el-tag>
            </template>
          </el-table-column>

          <el-table-column
            prop="addrs"
            label="IP Address"
            width="350"
            align="center"
          >
            <template slot-scope="scope">
              <el-tag
                v-for="(addr, index) in scope.row.addrs"
                v-bind:key="index"
                type="info"
                style="margin-right: 5px"
                >{{addr}}</el-tag
              >
            </template>
          </el-table-column>

          <el-table-column
            prop="status"
            label="Status"
            width="100"
            align="center"
          >
            <template slot-scope="scope">
              <el-tag :type="getSrvStatusTagType(scope.row.status)"
                >{{scope.row.status}}</el-tag
              >
            </template>
          </el-table-column>

          <el-table-column
            prop="cover"
            label="Code Coverage"
            width="350"
            align="center"
          >
            <template slot-scope="scope">
              <el-progress
                :text-inside="true"
                :stroke-width="26"
                :percentage="scope.row.cover"
                :status="getProgressBarType(scope.row.cover)"
              ></el-progress>
            </template>
          </el-table-column>

          <el-table-column
            fixed="right"
            label="Operations"
            width="350"
            align="center"
          >
            <template slot-scope="scope">
              <el-tooltip content="Refresh" placement="top">
                <el-button
                  plain
                  type="primary"
                  size="small"
                  icon="el-icon-refresh"
                  @click="onRefresh"
                ></el-button>
              </el-tooltip>
              <el-tooltip content="Force refresh" placement="top">
                <el-button
                  plain
                  type="danger"
                  size="small"
                  icon="el-icon-refresh"
                ></el-button>
              </el-tooltip>
              <el-tooltip content="Clear coverage" placement="top">
                <el-button
                  plain
                  type="warning"
                  size="small"
                  icon="el-icon-remove-outline"
                ></el-button>
              </el-tooltip>
              <el-dropdown style="margin-left: 10px">
                <el-button plain type="primary" size="small">
                  Report<i class="el-icon-arrow-down el-icon--right"></i>
                </el-button>
                <el-dropdown-menu slot="dropdown">
                  <el-dropdown-item @click.native="onFuncReport"
                    >Func Report</el-dropdown-item
                  >
                  <el-dropdown-item @click.native="onHtmlReport"
                    >Html Report</el-dropdown-item
                  >
                  <el-dropdown-item @click.native="onHistoryReport"
                    >History</el-dropdown-item
                  >
                </el-dropdown-menu>
              </el-dropdown>
            </template>
          </el-table-column>
        </el-table>
      </div>

      <!-- func cover report dialog -->
      <el-dialog
        title="Function Cover Report"
        :center="true"
        :visible.sync="isFuncReportDialogVisible"
      >
        <el-table :data="funcReportTableData" style="width: 85%; margin: auto">
          <el-table-column
            property="position"
            label="Position"
            width="400"
            align="center"
          >
            <template slot-scope="scope">
              <el-tag type="info">{{scope.row.position}}</el-tag>
            </template>
          </el-table-column>
          <el-table-column
            property="func"
            label="Function"
            width="200"
            align="center"
          >
            <template slot-scope="scope">
              <el-tag type="info">{{scope.row.func}}</el-tag>
            </template>
          </el-table-column>
          <el-table-column
            property="cover"
            label="Coverage"
            width="100"
            align="center"
          >
            <template slot-scope="scope">
              <el-tag :type="getCoverTagType(scope.row.cover)"
                >{{scope.row.cover}}</el-tag
              >
            </template>
          </el-table-column>
        </el-table>
      </el-dialog>

      <!-- html cover report dialog -->
      <el-dialog
        title="Html Cover Report"
        width="80%"
        :center="true"
        :visible.sync="isHtmlReportDialogVisible"
      >
        <iframe
          name="Html Cover Report"
          src="coverage_results.html"
          width="1375px"
          height="700px"
          frameborder="no"
        ></iframe>
      </el-dialog>
    </div>
  </body>
  <script src="../../modules/vue.js"></script>
  <script src="../../modules/element.js"></script>
  <script>
    let app = new Vue({
      el: '#app',
      data() {
        return {
          isFuncReportDialogVisible: false,
          isHtmlReportDialogVisible: false,
          tableData: [
            {
              index: 1,
              srv_name: 'staging_th_apa_goc_echoserver_v1_master_518e0a570c',
              addrs: ['http://127.0.0.1:49970', 'http://127.0.0.1:51007'],
              status: 'online',
              cover: '41.21',
            },
            {
              index: 2,
              srv_name: 'staging_th_apa_goc_echoserver_v2_master_518e0a570c',
              addrs: ['http://127.0.0.1:51025'],
              status: 'online',
              cover: '23.08',
            },
            {
              index: 3,
              srv_name: 'staging_th_apa_goc_echoserver_v3_master_518e0a570c',
              addrs: ['http://127.0.0.1:51029'],
              status: 'offline',
              cover: '68.17',
            },
          ],
          funcReportTableData: [
            {
              position: 'demo.hello/echoserver/handlers/cover.go:11',
              func: 'CoverHandler',
              cover: '100.0%',
            },
            {
              position: 'demo.hello/echoserver/handlers/cover.go:17',
              func: 'getCondition',
              cover: '0.0%',
            },
            {
              position: 'demo.hello/echoserver/handlers/ping.go:13',
              func: 'IndexHandler',
              cover: '100.0%',
            },
            {
              position: 'demo.hello/echoserver/handlers/users.go:17',
              func: 'getUsers',
              cover: '33.3%',
            },
          ],
        }
      },
      mounted() {
        console.log('mock onMounted')
      },
      methods: {
        getHeaderCellClassName({ row, column, rowIndex, columnIndex }) {
          return 'tb-header'
        },
        getProgressBarType(percentage) {
          if (parseFloat(percentage) < 30.0) {
            return 'exception'
          } else if (parseFloat(percentage) < 60.0) {
            return 'warning'
          } else {
            return 'success'
          }
        },
        getSrvStatusTagType(status) {
          return status.toLowerCase() == 'online' ? 'success' : 'danger'
        },
        getCoverTagType(percentage) {
          let percent = parseFloat(percentage.replace('%', ''))
          if (percent < 30.0) {
            return 'danger'
          } else if (percent < 60.0) {
            return 'warning'
          } else {
            return 'success'
          }
        },
        // event handler
        onRefresh() {
          console.log('mock onRefresh')
        },
        onFuncReport() {
          this.isFuncReportDialogVisible = true
        },
        onHtmlReport() {
          this.isHtmlReportDialogVisible = true
        },
        onHistoryReport() {
          console.log('mock onHistoryReport')
        },
      },
    })
  </script>
</html>
